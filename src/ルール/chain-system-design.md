# チェーンシステム設計書

作成日: 2025-11-27
目的: 刹那詠唱カードの発動タイミング制御システムの詳細仕様

---

## 概要

チェーンシステムは、相手ターン中に【刹那詠唱】を持つ魔法カードを発動するタイミングを制御するシステムです。
ゲームの特定のポイント（チェーンポイント）で非アクティブプレイヤーに発動機会を与えます。

---

## 基本概念

### チェーンポイント (Chain Point)
ゲーム中に刹那詠唱カードが発動可能になるタイミング。
現在のフェイズ移行や特定アクション時に設定される。

### 非アクティブプレイヤー (Non-Active Player)
現在ターンを進行していないプレイヤー。
相手ターン中の自分のこと。

### Phase A / Phase B

| Phase | 説明 | 状態 |
|-------|------|------|
| Phase A | 1チェーンのみ。相互チェーン（チェーン on チェーン）なし | **実装済** |
| Phase B | 複数チェーン対応。スタック構造でLIFO順解決 | 将来実装 |

---

## チェーンポイント一覧

### 実装済み

| チェーンポイント | タイミング | 説明 |
|-----------------|-----------|------|
| `BATTLE_START` | メインフェイズ → バトルフェイズ移行時 | バトルフェイズ開始前に発動機会 |
| `ATTACK_DECLARATION` | モンスター攻撃宣言時 | 攻撃が実行される前に発動機会 |

### 将来実装予定

| チェーンポイント | タイミング | 説明 |
|-----------------|-----------|------|
| `SUMMON` | モンスター召喚時 | 召喚成功後、効果発動前に発動機会 |
| `MAGIC_ACTIVATION` | 魔法カード発動時 | 魔法効果解決前に発動機会 |

---

## 発動フロー

### 1. バトルフェイズ開始時 (BATTLE_START)

```
メインフェイズ中
    ↓
[アクティブプレイヤー] 「バトルフェイズへ」ボタン押下
    ↓
[システム] 非アクティブプレイヤーに刹那詠唱カードがあるか確認
    ├─ ない場合 → 直接バトルフェイズへ移行
    └─ ある場合 → チェーン確認ダイアログ表示
                    ↓
              [非アクティブプレイヤー] 選択
                    ├─ 「発動しない」→ バトルフェイズへ移行
                    └─ カード選択 → 効果発動 → バトルフェイズへ移行
```

### 2. 攻撃宣言時 (ATTACK_DECLARATION)

```
バトルフェイズ中
    ↓
[アクティブプレイヤー] モンスターで攻撃宣言（ターゲット選択）
    ↓
[システム] 非アクティブプレイヤーに刹那詠唱カードがあるか確認
    ├─ ない場合 → 直接攻撃実行
    └─ ある場合 → チェーン確認ダイアログ表示
                    ↓
              [非アクティブプレイヤー] 選択
                    ├─ 「発動しない」→ 攻撃実行
                    └─ カード選択 → 効果発動 → 攻撃実行
```

---

## コスト計算

### 刹那詠唱コスト

```
刹那詠唱コスト = カードの通常コスト + 1
```

**例:**
- 通常コスト2の魔法カード → 刹那詠唱時コスト3
- 通常コスト0の魔法カード → 刹那詠唱時コスト1

### 発動可能条件

非アクティブプレイヤーが刹那詠唱カードを発動可能な条件:
1. 手札に【刹那詠唱】を持つ魔法カードがある
2. アクティブSPが刹那詠唱コスト以上ある

---

## 状態管理

### chainConfirmation オブジェクト

```javascript
const chainConfirmation = {
  chainPoint: 'battle_start' | 'attack_declaration',  // チェーンポイント種類
  askingPlayer: 1 | 2,          // 確認中のプレイヤー
  pendingAction: {              // 保留中のアクション
    type: 'attack' | 'battleStart',
    attackerIndex?: number,     // 攻撃時のみ
    targetIndex?: number,       // 攻撃時のみ
  },
  context: {                    // 追加コンテキスト
    attacker?: MonsterObject,   // 攻撃時: 攻撃モンスター情報
  },
};
```

### ライフサイクル

```
1. チェーンポイント発生
   ↓
2. startChainConfirmation() 呼び出し
   - 発動可能カードがなければ false を返して即座に続行
   - あれば chainConfirmation を設定して true を返す
   ↓
3. チェーン確認ダイアログ表示
   ↓
4. プレイヤーが選択
   ├─ skipChainConfirmation() → 発動せず続行
   └─ activateSetsunaInChain(card) → カード発動して続行
   ↓
5. chainConfirmation を null に戻す
   ↓
6. 保留中のアクションを実行
```

---

## UI仕様

### チェーン確認ダイアログ

**表示位置**: 画面中央（モーダル）
**Z-index**: 1100（最前面）

**構成要素**:
1. ヘッダー: 「【刹那詠唱】チェーン確認」
2. チェーンポイント表示: 「バトルフェイズ開始時」「攻撃宣言時」など
3. プレイヤー表示: 「プレイヤーX、刹那詠唱を発動しますか？」
4. 攻撃情報（攻撃宣言時のみ）: 攻撃モンスター名
5. 発動可能カード一覧: カード名とコスト
6. 選択中カード詳細: 効果テキスト
7. アクションボタン:
   - 「⚡ [カード名]を発動」（カード選択時のみ表示）
   - 「発動しない」

**カラースキーム**:
- メイン: 紫系 (#9c6bff)
- プレイヤー1: 青 (#4da6ff)
- プレイヤー2: 赤 (#ff6b6b)

---

## スタック構造（Phase B準備）

### スタックアイテム

```javascript
const stackItem = {
  id: 'unique-id',           // 一意識別子
  card: CardObject,          // 発動するカード
  player: 1 | 2,             // 発動プレイヤー
  chainPoint: 'attack_declaration',  // チェーンポイント
  context: {},               // 追加コンテキスト
  timestamp: Date.now(),     // 作成時刻
};
```

### スタック解決順序（Phase B）

Phase Bでは複数のチェーンが積まれた場合、**LIFO（後入れ先出し）**で解決:

```
スタック状態:
[0] プレイヤー1の刹那詠唱カードA
[1] プレイヤー2の刹那詠唱カードB  ← 最後に積まれた

解決順序:
1. カードB の効果を解決
2. カードA の効果を解決
```

---

## 関連関数

### keywordAbilities/index.js

| 関数 | 説明 |
|------|------|
| `isSetsunaMagic(card)` | カードが刹那詠唱を持つ魔法カードか判定 |
| `getSetsunaCost(card)` | 刹那詠唱時のコストを計算 |
| `getActivatableSetsunaMagics(hand, activeSP)` | 発動可能な刹那詠唱カード一覧を取得 |
| `createStackItem(card, player, chainPoint, context)` | スタックアイテム作成 |
| `resolveStack(stack, resolveEffect)` | スタック解決（LIFO順） |

### magic-spirit.jsx

| 関数 | 説明 |
|------|------|
| `canNonActivePlayerUseSetsuna()` | 非アクティブプレイヤーが発動可能か |
| `startChainConfirmation(chainPoint, pendingAction, context)` | チェーン確認開始 |
| `skipChainConfirmation()` | チェーンをスキップ |
| `activateSetsunaInChain(card)` | チェーン内で刹那詠唱発動 |
| `attack(attackerIndex, targetIndex)` | 攻撃開始（チェーン確認を含む） |
| `executeAttack(attackerIndex, targetIndex)` | 攻撃実行（チェーン確認後） |

---

## 制限事項

### Phase A の制限

1. **1チェーンのみ**: 刹那詠唱に対して刹那詠唱で対抗することはできない
2. **確認は1回のみ**: 各チェーンポイントで確認は1回のみ
3. **発動後は即続行**: 効果解決後、自動的に保留中のアクションが実行される

### 将来の拡張（Phase B）

1. **相互チェーン対応**: 刹那詠唱に対して刹那詠唱で対抗可能
2. **チェーン積み上げ**: 複数のチェーンをスタックに積める
3. **LIFO解決**: 最後に積まれたものから順に解決
4. **チェーン制限**: チェーン数の上限を設定可能

---

## エッジケース

### 発動可能カードがない場合
- チェーン確認ダイアログは表示されない
- 直接次のアクションに進む

### SP不足の場合
- 手札に刹那詠唱カードがあってもSPが足りなければ発動不可
- 発動可能カード一覧に表示されない

### 効果でモンスターが破壊された場合
- 攻撃対象が存在しなくなった場合でも攻撃は実行される
- 攻撃対象がいなければダイレクトアタック判定

### 効果でSPが変動した場合
- 刹那詠唱発動後にSPが変動しても、その時点では再計算しない
- 次のチェーンポイントで再評価

---

## 更新履歴

| 日付 | 更新内容 |
|------|----------|
| 2025-11-27 | 初版作成 |
